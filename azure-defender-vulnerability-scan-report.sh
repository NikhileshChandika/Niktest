#!/usr/bin/env bash 
set -e

echo "Setting Variables By Querying Parameters"
az_vm=$1
echo "Azure VM:$az_vm"
client_id=$2
echo "AzCopy Client ID:$client_id"
client_secret=$3
tenant_id=$4
echo "Azure Tenant ID:$tenant_id"
os=$5
echo "Operating System:$os"
storageaccount=$6
echo "Storage Account:$storageaccount"
resourcegroup=$7
echo "Resource Group Name:$resourcegroup"

echo "Download CIS Report"
export AZCOPY_AUTO_LOGIN_TYPE=SPN
export AZCOPY_SPA_APPLICATION_ID=$client_id
export AZCOPY_SPA_CLIENT_SECRET=$client_secret
export AZCOPY_TENANT_ID=$tenant_id

echo "Create Json Report from Azure Defender Findings"
az graph query -q 'securityresources | where type == "microsoft.security/assessments" | where * contains "Machines should have vulnerability findings resolved" | where resourceGroup == "'$resourcegroup'" | summarize by assessmentKey=name | join kind=inner ( securityresources | where type == "microsoft.security/assessments/subassessments" | where resourceGroup == "'$resourcegroup'" | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id) ) on assessmentKey | project assessmentKey, subassessmentKey=name, id, parse_json(properties), resourceGroup, subscriptionId, tenantId | extend description = properties.description,displayName = properties.displayName,resourceId = properties.resourceDetails.id,resourceSource = properties.resourceDetails.source,category = properties.category,severity = properties.status.severity,code = properties.status.code,timeGenerated = properties.timeGenerated,remediation = properties.remediation,impact = properties.impact,vulnId = properties.id,additionalData = properties.additionalData' --output json > Defender_Findings_Report.json

echo "Copying Azure Defender Findings Report to Storage Account"
azcopy copy Defender_Findings_Report.json https://$storageaccount.blob.core.windows.net/azuredefender/$os/reports/$az_vm/Defender_Findings_Report.json

echo "Copied Defender_Findings_Report.json to Storage Account"